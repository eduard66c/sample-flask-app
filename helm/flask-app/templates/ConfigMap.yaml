apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "flask-app.fullname" . }}-promtail-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "flask-app.labels" . | nindent 4 }}
data:
  promtail-config.yaml: |
    server:
      http_listen_port: {{ .Values.promtail.port }}
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: {{ .Values.promtail.loki.url }}

    scrape_configs:
      # Flask application logs
      - job_name: flask-app
        static_configs:
          - targets:
              - flask-app
            labels:
              job: flask-app
              __path__: /var/tmp/flask-app.log
        pipeline_stages:
          - regex:
              expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) module=(?P<module>\S+) level=(?P<level>\w+): (?P<message>.*)$'
          - labels:
              level:
          - timestamp:
              source: timestamp
              format: '2006-01-02 15:04:05,000'

      - job_name: system
        static_configs:
          - targets:
              - localhost
            labels:
              job: syslog
              __path__: /var/log/syslog